'use client'

import React, { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Switch } from '@/components/ui/switch'
import { ProfileSkeleton } from '@/components/ui/skeleton'

import { 
  Edit3, 
  Save, 
  X, 
  Gift, 
  Bell, 
  Mail, 
  Settings,
  Heart,
  Calendar,
  MessageSquare,
  User,
  MapPin,
  GraduationCap,
  Briefcase,
  Camera,
  Plus,
  Shield,
  CheckCircle,
  AlertCircle
} from 'lucide-react'
import StorySettings from './StorySettings'
import AnalyticsDashboard from '@/components/admin/AnalyticsDashboard'
import { KoreanUserProfile, LatinUserProfile } from '@/types/user'
import { useLanguage } from '@/context/LanguageContext'
import { useAuth } from '@/context/AuthContext'
// ğŸš€ ìµœì í™”: React Query hooks ì¶”ê°€
import { useUserProfile, useUpdateProfile } from '@/hooks/useUserProfile'

// ëª©ì—… ë°ì´í„° ì œê±° - ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì‚¬ìš©

export default function MyTab() {
  const { t } = useLanguage()
  const { user, token } = useAuth()
  const router = useRouter()
  const [isEditing, setIsEditing] = useState(false)
  const [editForm, setEditForm] = useState({
    full_name: '',
    korean_name: '',
    spanish_name: '',
    nickname: '',
    phone: '',
    one_line_intro: '',
    introduction: '',
    language: 'ko',
    user_type: 'student',
    university: '',
    major: '',
    grade: '',
    occupation: '',
    company: '',
    career: '',
    interests: [] as string[],
    profile_images: [] as string[]
  })
  const [newInterest, setNewInterest] = useState('')
  const [isSaving, setIsSaving] = useState(false)
  const [profile, setProfile] = useState<any>(null)
  const [loading, setLoading] = useState(true)
  const [authStatus, setAuthStatus] = useState({ loading: true, smsVerified: false })
  const [verificationStatus, setVerificationStatus] = useState<{
    isVerified: boolean
    status: 'none' | 'email' | 'sms' | 'full'
    message: string
  }>({
    isVerified: false,
    status: 'none',
    message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤'
  })
  const [notificationSettings, setNotificationSettings] = useState({
    webPush: true,
    email: false,
    marketing: false
  })

  // í”„ë¡œí•„ ì‚¬ì§„ ìŠ¤ì™€ì´í”„ ìƒíƒœ
  const [currentImageIndex, setCurrentImageIndex] = useState(0)
  const [startX, setStartX] = useState(0)
  const [isDragging, setIsDragging] = useState(false)
  
  // ëª©ì—… í”„ë¡œí•„ ì‚¬ì§„ë“¤ (ì‹¤ì œë¡œëŠ” ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì‚¬ì§„ë“¤)
  // í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜´

  // í¸ì§‘ í¼ ì´ˆê¸°í™”
  const initializeEditForm = (profileData: any) => {
    setEditForm({
      full_name: profileData?.name || profileData?.full_name || '',
      korean_name: profileData?.korean_name || '',
      spanish_name: profileData?.spanish_name || '',
      nickname: profileData?.nickname || '',
      phone: profileData?.phone || '',
      one_line_intro: profileData?.bio || profileData?.one_line_intro || '',
      introduction: profileData?.introduction || '',
      language: profileData?.native_language || profileData?.language || 'ko',
      user_type: profileData?.userType || profileData?.user_type || 'student',
      university: profileData?.university || '',
      major: profileData?.major || '',
      grade: profileData?.grade || '',
      occupation: profileData?.occupation || '',
      company: profileData?.company || '',
      career: profileData?.career || '',
      interests: profileData?.interests || [],
      profile_images: profileData?.profileImages?.map((img: any) => img.src) || profileData?.profile_images || []
    })
  }

  // í”„ë¡œí•„ ì €ì¥
  const handleSaveProfile = async () => {
    if (!user || !token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
          return
        }
        
    setIsSaving(true)
    try {
      const response = await fetch('/api/profile', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(editForm)
      })

      if (response.ok) {
        const data = await response.json()
        setProfile(data.user)
        setIsEditing(false)
        alert('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')
      } else {
        throw new Error('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨')
      }
    } catch (error) {
      console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error)
      alert('í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')
    } finally {
      setIsSaving(false)
    }
  }

  // ê´€ì‹¬ì‚¬ ì¶”ê°€
  const handleAddInterest = () => {
    if (newInterest.trim() && !editForm.interests.includes(newInterest.trim())) {
      setEditForm(prev => ({
        ...prev,
        interests: [...prev.interests, newInterest.trim()]
      }))
      setNewInterest('')
    }
  }

  // ê´€ì‹¬ì‚¬ ì œê±°
  const handleRemoveInterest = (interestToRemove: string) => {
    setEditForm(prev => ({
      ...prev,
      interests: prev.interests.filter(interest => interest !== interestToRemove)
    }))
  }

  // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    const loadProfile = async () => {
      if (!user) {
        setLoading(false)
        return
      }

      try {
        setLoading(true)
        
        // API í˜¸ì¶œ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ëª©ì—… ë°ì´í„° ì‚¬ìš©)
        if (token) {
          try {
            const response = await fetch('/api/profile', {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            })

            if (response.ok) {
              const data = await response.json()
              setProfile(data.user || data.profile)
              initializeEditForm(data.user || data.profile)
              setLoading(false)
            return
          }
          } catch (error) {
            console.log('API í˜¸ì¶œ ì‹¤íŒ¨, ëª©ì—… ë°ì´í„° ì‚¬ìš©')
          }
        }
        
        // API ì‹¤íŒ¨ ì‹œ ë¹ˆ í”„ë¡œí•„ ì„¤ì •
        setProfile(null)
        initializeEditForm(null)
      } catch (error) {
        console.error('í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error)
        // ì˜¤ë¥˜ ì‹œ ë¹ˆ í”„ë¡œí•„ ì„¤ì •
        setProfile(null)
        initializeEditForm(null)
      } finally {
        setLoading(false)
      }
    }

    loadProfile()
  }, [user, token])

  // ì¸ì¦ ìƒíƒœ í™•ì¸
  const checkVerificationStatus = async () => {
    if (!user || !token) {
      setVerificationStatus({
        isVerified: false,
        status: 'none',
        message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'
      })
      return
    }

    try {
      const response = await fetch(`/api/verification?userId=${user.id}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })

      if (response.ok) {
        const data = await response.json()
        const verification = data.verification
        
        setVerificationStatus({
          isVerified: verification.status === 'approved',
          status: verification.status === 'approved' ? 'full' : 'none',
          message: verification.message
        })
      } else {
        setVerificationStatus({
          isVerified: false,
          status: 'none',
          message: 'ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
        })
      }
    } catch (error) {
      console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error)
      setVerificationStatus({
        isVerified: false,
        status: 'none',
        message: 'ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      })
    }
  }

  useEffect(() => {
    const checkAuthStatus = async () => {
      if (!user) {
        setAuthStatus({ loading: false, smsVerified: false })
        return
      }
        
      // ì‹¤ì œ ì¸ì¦ ìƒíƒœ í™•ì¸ (ë‚˜ì¤‘ì— API ì—°ë™)
      setAuthStatus({ loading: false, smsVerified: true })
    }

    checkAuthStatus()
    checkVerificationStatus()
  }, [user, token])

  // ì•Œë¦¼ ì„¤ì • ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleNotificationChange = (key: string, value: boolean) => {
    setNotificationSettings(prev => ({
      ...prev,
      [key]: value
    }))
  }

  // í”„ë¡œí•„ ì‚¬ì§„ ìŠ¤ì™€ì´í”„ í•¸ë“¤ëŸ¬ë“¤
  const handleTouchStart = (e: React.TouchEvent) => {
    setStartX(e.touches[0].clientX)
    setIsDragging(true)
  }

  const handleTouchEnd = (e: React.TouchEvent) => {
    if (!isDragging) return
    
    const endX = e.changedTouches[0].clientX
    const diff = startX - endX
    const threshold = 50

    if (Math.abs(diff) > threshold) {
      if (diff > 0) {
        // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ ì‚¬ì§„)
        setCurrentImageIndex(prev => 
          prev < (profile?.profile_images?.length || 1) - 1 ? prev + 1 : 0
        )
      } else {
        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ì´ì „ ì‚¬ì§„)
        setCurrentImageIndex(prev => 
          prev > 0 ? prev - 1 : (profile?.profile_images?.length || 1) - 1
        )
      }
    }
    
    setIsDragging(false)
  }

  const handleMouseDown = (e: React.MouseEvent) => {
    setStartX(e.clientX)
    setIsDragging(true)
  }

  const handleMouseUp = (e: React.MouseEvent) => {
    if (!isDragging) return
    
    const endX = e.clientX
    const diff = startX - endX
    const threshold = 50

    if (Math.abs(diff) > threshold) {
      if (diff > 0) {
        // ì™¼ìª½ìœ¼ë¡œ ë“œë˜ê·¸ (ë‹¤ìŒ ì‚¬ì§„)
        setCurrentImageIndex(prev => 
          prev < (profile?.profile_images?.length || 1) - 1 ? prev + 1 : 0
        )
      } else {
        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë“œë˜ê·¸ (ì´ì „ ì‚¬ì§„)
        setCurrentImageIndex(prev => 
          prev > 0 ? prev - 1 : (profile?.profile_images?.length || 1) - 1
        )
      }
    }
    
    setIsDragging(false)
  }

  const handleMouseLeave = () => {
    setIsDragging(false)
  }

  // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
  const isAdmin = user?.email === 'admin@amiko.com'

  if (loading) {
    return <ProfileSkeleton />
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
          <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">{t('myTab.loading')}</p>
        </div>
      </div>
    )
  }

  // í”„ë¡œí•„ì´ ì—†ì„ ë•Œì˜ ìƒíƒœ
  if (!profile) {
    return (
      <div className="min-h-screen bg-white">
        <div className="w-full">
          {/* ë¹ˆ í”„ë¡œí•„ ìƒíƒœ */}
          <div className="relative h-80 bg-gray-100 flex items-center justify-center">
            <div className="text-center text-gray-500">
              <User className="w-16 h-16 mx-auto mb-4" />
              <h2 className="text-lg font-semibold mb-2">í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”</h2>
              <p className="text-sm">í¸ì§‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ í”„ë¡œí•„ì„ ì™„ì„±í•´ë³´ì„¸ìš”</p>
            </div>
          </div>

          {/* í¸ì§‘ ë²„íŠ¼ (ëª¨ë°”ì¼) */}
          <div className="px-4 py-2 bg-white md:hidden">
            <div className="flex items-center justify-between">
              <h1 className="text-lg font-semibold text-gray-800">ë‚´ í”„ë¡œí•„</h1>
              <button
                onClick={() => setIsEditing(true)}
                className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center shadow-sm text-white"
              >
                <Edit3 className="w-4 h-4" />
              </button>
            </div>
          </div>

          {/* ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ (í¸ì§‘ ëª¨ë“œ) */}
          <div className="px-4 py-4 bg-gray-50">
            <div className="flex items-center gap-2 mb-3">
              <User className="w-4 h-4 text-blue-500" />
              <h2 className="font-semibold text-gray-800">ê¸°ë³¸ ì •ë³´</h2>
            </div>
            <p className="text-gray-600 text-sm">í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”</p>
          </div>
        </div>
      </div>
    )
  }

  // í‹´ë” ìŠ¤íƒ€ì¼ ë©”ì¸ ë ˆì´ì•„ì›ƒ
  return (
    <div className="min-h-screen bg-white">
      {/* í‹´ë” ìŠ¤íƒ€ì¼ í’€ìŠ¤í¬ë¦° ì»¨í…Œì´ë„ˆ */}
      <div className="w-full">
        
        {/* í”„ë¡œí•„ í—¤ë” ì„¹ì…˜ - ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ */}
            <div className="relative">
          {/* í”„ë¡œí•„ ì‚¬ì§„ ìŠ¤ì™€ì´í”„ ì˜ì—­ */}
          <div 
            className="relative h-80 bg-gray-100 overflow-hidden cursor-grab active:cursor-grabbing select-none"
            onTouchStart={handleTouchStart}
            onTouchEnd={handleTouchEnd}
            onMouseDown={handleMouseDown}
            onMouseUp={handleMouseUp}
            onMouseLeave={handleMouseLeave}
          >
                 {/* í”„ë¡œí•„ ì‚¬ì§„ë“¤ */}
                 <div
                   className="flex h-full transition-transform duration-300 ease-in-out"
                   style={{
                     transform: `translateX(-${currentImageIndex * 100}%)`,
                     userSelect: 'none',
                     WebkitUserSelect: 'none'
                   }}
                 >
                   {profile?.profile_images?.length > 0 ? (
                     profile.profile_images.map((imageSrc: string, index: number) => (
                       <div key={index} className="w-full h-full flex-shrink-0 relative">
                         <img
                           src={imageSrc}
                           alt={`í”„ë¡œí•„ ${index + 1}`}
                           className="w-full h-full object-cover"
                           draggable={false}
                           onDragStart={(e) => e.preventDefault()}
                         />
                         {/* ì‚¬ì§„ ì¸ë””ì¼€ì´í„° */}
                         <div className="absolute top-4 right-4 bg-black/50 text-white px-2 py-1 rounded-full text-xs">
                           {index + 1}/{profile.profile_images.length}
                         </div>
                       </div>
                     ))
                   ) : (
                     <div className="w-full h-full flex-shrink-0 relative bg-gray-200 flex items-center justify-center">
                       <div className="text-center text-gray-500">
                         <Camera className="w-16 h-16 mx-auto mb-2" />
                         <p className="text-sm">í”„ë¡œí•„ ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
                       </div>
                     </div>
                   )}
                 </div>
              
            {/* í•˜ë‹¨ ì¸ë””ì¼€ì´í„° ì ë“¤ */}
            <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
              {profile?.profile_images?.length > 0 ? (
                profile.profile_images.map((_, index) => (
                  <div
                    key={index}
                    className={`w-2 h-2 rounded-full transition-all duration-300 ${
                      index === currentImageIndex ? 'bg-white' : 'bg-white/50'
                    }`}
                  />
                ))
              ) : null}
            </div>

            {/* ì¹´ë©”ë¼ ë²„íŠ¼ */}
            <button className="absolute bottom-4 right-4 w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
              <Camera className="w-6 h-6 text-gray-600" />
                      </button>
            
            {/* ìŠ¤ì™€ì´í”„ íŒíŠ¸ (í”„ë¡œí•„ ì‚¬ì§„ì´ ì—¬ëŸ¬ ì¥ ìˆì„ ë•Œë§Œ í‘œì‹œ) */}
            {profile?.profile_images?.length > 1 && currentImageIndex === 0 && (
              <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-xs animate-pulse">
                â† ìŠ¤ì™€ì´í”„í•´ì„œ ë” ë³´ê¸° â†’
              </div>
            )}
                    </div>

          {/* í”„ë¡œí•„ ì •ë³´ ì˜¤ë²„ë ˆì´ */}
          <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
            <div className="flex items-end justify-between">
              <div className="flex-1">
                <h1 className="text-2xl font-bold text-white">
                  {profile?.full_name || profile?.name || 'í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”'}
                </h1>
                <p className="text-white/90 text-sm">
                  {profile?.user_type === 'student' || profile?.userType === 'student'
                    ? `${profile?.university || ''} ${profile?.major || ''} ${profile?.grade || ''}`.trim() || 'í•™ìƒ'
                    : profile?.occupation || 'ì§ì¥ì¸'
                  }
                </p>
                <p className="text-white/80 text-xs mt-1">
                  ê°€ì…ì¼: {profile?.join_date || profile?.joinDate || new Date().toISOString().split('T')[0]}
                </p>
              </div>
              
              {/* ì¸ì¦ ìƒíƒœ ë° ì¸ì¦ì„¼í„° ë²„íŠ¼ */}
              <div className="flex flex-col items-end gap-2">
                {/* ì¸ì¦ ìƒíƒœ í‘œì‹œ */}
                <div className="flex items-center gap-1">
                  {verificationStatus.isVerified ? (
                    <>
                      <CheckCircle className="w-4 h-4 text-green-400" />
                      <span className="text-green-400 text-xs">ì¸ì¦ì™„ë£Œ</span>
                    </>
                  ) : (
                    <>
                      <AlertCircle className="w-4 h-4 text-yellow-400" />
                      <span className="text-yellow-400 text-xs">ì¸ì¦í•„ìš”</span>
                    </>
                  )}
                </div>
                
                {/* ì¸ì¦ì„¼í„° ë²„íŠ¼ */}
                <Button
                  onClick={() => router.push('/verification-center')}
                  size="sm"
                  className={`text-xs px-3 py-1 h-7 ${
                    verificationStatus.isVerified 
                      ? 'bg-green-600 hover:bg-green-700' 
                      : 'bg-yellow-600 hover:bg-yellow-700'
                  }`}
                >
                  <Shield className="w-3 h-3 mr-1" />
                  {verificationStatus.isVerified ? 'ì¸ì¦ì„¼í„°' : 'ì¸ì¦í•˜ê¸°'}
                </Button>
              </div>
            </div>
          </div>

             {/* í¸ì§‘ ë²„íŠ¼ (ëª¨ë°”ì¼) */}
             <div className="px-4 py-2 bg-white md:hidden">
               <div className="flex items-center justify-between">
                 <h1 className="text-lg font-semibold text-gray-800">ë‚´ í”„ë¡œí•„</h1>
                 <div className="flex items-center gap-2">
                {isEditing ? (
                  <>
                       <button
                         onClick={() => setIsEditing(false)}
                         className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center shadow-sm border border-gray-200"
                       >
                         <X className="w-4 h-4 text-gray-600" />
                       </button>
                       <button
                      onClick={handleSaveProfile}
                         disabled={isSaving}
                         className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center shadow-sm text-white"
                       >
                         {isSaving ? (
                           <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                         ) : (
                           <Save className="w-4 h-4" />
                         )}
                       </button>
                  </>
                ) : (
                     <button
                    onClick={() => setIsEditing(true)}
                       className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center shadow-sm border border-gray-200"
                  >
                       <Edit3 className="w-4 h-4 text-gray-600" />
                     </button>
                )}
              </div>
              </div>
            </div>

        {/* ê´€ì‹¬ì‚¬ ì„¹ì…˜ */}
        <div className="px-4 py-4 bg-gray-50">
          <div className="flex items-center gap-2 mb-3">
            <Heart className="w-4 h-4 text-pink-500" />
            <h2 className="font-semibold text-gray-800">ê´€ì‹¬ì‚¬</h2>
          </div>

          {isEditing ? (
            <div className="space-y-3">
              {/* ê¸°ì¡´ ê´€ì‹¬ì‚¬ í‘œì‹œ */}
              <div className="flex flex-wrap gap-2">
                {editForm.interests.map((interest: string, index: number) => (
                  <span
                    key={index}
                    className="px-3 py-1 bg-white text-gray-700 rounded-full text-sm border border-gray-200 flex items-center gap-1"
                  >
                    {interest}
                    <button
                      onClick={() => handleRemoveInterest(interest)}
                      className="text-red-500 hover:text-red-700"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </span>
                ))}
              </div>

              {/* ìƒˆ ê´€ì‹¬ì‚¬ ì¶”ê°€ */}
              <div className="flex gap-2">
                <Input
                  value={newInterest}
                  onChange={(e) => setNewInterest(e.target.value)}
                  placeholder="ê´€ì‹¬ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                  className="text-sm"
                  onKeyPress={(e) => e.key === 'Enter' && handleAddInterest()}
                />
                <Button
                  onClick={handleAddInterest}
                  size="sm"
                  className="px-3"
                >
                  <Plus className="w-4 h-4" />
                </Button>
              </div>
            </div>
          ) : (
            <div className="flex flex-wrap gap-2">
              {profile?.interests?.length > 0 ? (
                profile.interests.map((interest: string, index: number) => (
                  <span
                    key={index}
                    className="px-3 py-1 bg-white text-gray-700 rounded-full text-sm border border-gray-200"
                  >
                    {interest}
                  </span>
                ))
              ) : (
                <span className="px-3 py-1 bg-white text-gray-500 rounded-full text-sm border border-gray-200">
                  ê´€ì‹¬ì‚¬ ì—†ìŒ
                </span>
              )}
            </div>
          )}
        </div>
                  
        {/* ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ */}
        <div className="px-4 py-4 bg-gray-50">
          <div className="flex items-center gap-2 mb-3">
            <User className="w-4 h-4 text-blue-500" />
            <h2 className="font-semibold text-gray-800">ê¸°ë³¸ ì •ë³´</h2>
          </div>

                {isEditing ? (
            <div className="space-y-4">
              {/* ê¸°ë³¸ ì •ë³´ ì…ë ¥ í•„ë“œë“¤ */}
              <div className="grid grid-cols-1 gap-3">
                <div>
                  <label className="text-gray-600 text-sm block mb-1">í•œêµ­ì´ë¦„</label>
                  <Input
                    value={editForm.korean_name}
                    onChange={(e) => setEditForm(prev => ({ ...prev, korean_name: e.target.value }))}
                    placeholder="í•œêµ­ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    className="text-sm"
                  />
              </div>
              
                <div>
                  <label className="text-gray-600 text-sm block mb-1">ë‹‰ë„¤ì„</label>
                  <Input
                    value={editForm.nickname}
                    onChange={(e) => setEditForm(prev => ({ ...prev, nickname: e.target.value }))}
                    placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    className="text-sm"
                  />
              </div>

                <div>
                  <label className="text-gray-600 text-sm block mb-1">ìŠ¤í˜ì¸ì–´ ì´ë¦„</label>
                    <Input
                    value={editForm.spanish_name}
                    onChange={(e) => setEditForm(prev => ({ ...prev, spanish_name: e.target.value }))}
                    placeholder="ìŠ¤í˜ì¸ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    className="text-sm"
                  />
                  </div>
                
                <div>
                  <label className="text-gray-600 text-sm block mb-1">ì‚¬ìš©ì íƒ€ì…</label>
                  <Select value={editForm.user_type} onValueChange={(value) => setEditForm(prev => ({ ...prev, user_type: value }))}>
                    <SelectTrigger className="text-sm">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="student">í•™ìƒ</SelectItem>
                      <SelectItem value="worker">ì§ì¥ì¸</SelectItem>
                    </SelectContent>
                  </Select>
              </div>
              
                {/* ì‚¬ìš©ì íƒ€ì…ì— ë”°ë¥¸ ì…ë ¥ í•„ë“œ */}
                {editForm.user_type === 'student' ? (
                <>
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">ëŒ€í•™êµ</label>
                      <Input
                        value={editForm.university}
                        onChange={(e) => setEditForm(prev => ({ ...prev, university: e.target.value }))}
                        placeholder="ëŒ€í•™êµë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                  </div>
                  
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">ì „ê³µ</label>
                      <Input
                        value={editForm.major}
                        onChange={(e) => setEditForm(prev => ({ ...prev, major: e.target.value }))}
                        placeholder="ì „ê³µì„ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                  </div>
                    
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">í•™ë…„</label>
                      <Input
                        value={editForm.grade}
                        onChange={(e) => setEditForm(prev => ({ ...prev, grade: e.target.value }))}
                        placeholder="í•™ë…„ì„ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                    </div>
                  </>
                ) : (
                  <>
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">ì§ì—…</label>
                      <Input
                        value={editForm.occupation}
                        onChange={(e) => setEditForm(prev => ({ ...prev, occupation: e.target.value }))}
                        placeholder="ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                  </div>
                  
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">íšŒì‚¬</label>
                      <Input
                        value={editForm.company}
                        onChange={(e) => setEditForm(prev => ({ ...prev, company: e.target.value }))}
                        placeholder="íšŒì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                  </div>
                    
                    <div>
                      <label className="text-gray-600 text-sm block mb-1">ê²½ë ¥</label>
                    <Input
                        value={editForm.career}
                        onChange={(e) => setEditForm(prev => ({ ...prev, career: e.target.value }))}
                        placeholder="ê²½ë ¥ì„ ì…ë ¥í•˜ì„¸ìš”"
                        className="text-sm"
                      />
                </div>
                  </>
                )}
                
                <div>
                  <label className="text-gray-600 text-sm block mb-1">ìê¸°ì†Œê°œ</label>
                <Textarea
                    value={editForm.introduction}
                    onChange={(e) => setEditForm(prev => ({ ...prev, introduction: e.target.value }))}
                    placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    className="text-sm min-h-[80px]"
                  />
                </div>
              </div>
            </div>
          ) : (
            <div className="space-y-3">
              {/* í•œêµ­ì´ë¦„ */}
              <div className="flex items-center justify-between">
                <span className="text-gray-600 text-sm">í•œêµ­ì´ë¦„</span>
                <span className="text-gray-800 text-sm font-medium">
                  {profile?.korean_name || 'í•œêµ­ì´ë¦„ ì—†ìŒ'}
                </span>
            </div>

              {/* êµ¬ë¶„ì„  */}
              <div className="border-t border-gray-200"></div>

              {/* ë‹‰ë„¤ì„ */}
              <div className="flex items-center justify-between">
                <span className="text-gray-600 text-sm">ë‹‰ë„¤ì„ (ì•ŒíŒŒë²³, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì)</span>
                <span className="text-gray-800 text-sm font-medium">
                  {profile?.nickname || 'ë‹‰ë„¤ì„ ë¯¸ì„¤ì •'}
                </span>
                </div>

              {/* êµ¬ë¶„ì„  */}
              <div className="border-t border-gray-200"></div>

              {/* ìŠ¤í˜ì¸ì–´ ì´ë¦„ */}
              <div className="flex items-center justify-between">
                <span className="text-gray-600 text-sm">ìŠ¤í˜ì¸ì–´ ì´ë¦„</span>
                <span className="text-gray-800 text-sm font-medium">
                  {profile?.spanish_name || 'ìŠ¤í˜ì¸ì–´ ì´ë¦„ ì—†ìŒ'}
                </span>
              </div>

              {/* êµ¬ë¶„ì„  */}
              <div className="border-t border-gray-200"></div>

              {/* ì‚¬ìš©ì íƒ€ì…ì— ë”°ë¥¸ ì •ë³´ í‘œì‹œ */}
              {profile?.userType === 'student' || profile?.user_type === 'student' ? (
                <>
                  {/* í•™ë ¥ ì •ë³´ (ëŒ€í•™ìƒì¸ ê²½ìš°) */}
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">ëŒ€í•™êµ</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.university || 'ëŒ€í•™êµ ì—†ìŒ'}
                    </span>
                  </div>

                  {/* êµ¬ë¶„ì„  */}
                  <div className="border-t border-gray-200"></div>

                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">ì „ê³µ</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.major || 'ì „ê³µ ì—†ìŒ'}
                    </span>
                  </div>

                  {/* êµ¬ë¶„ì„  */}
                  <div className="border-t border-gray-200"></div>

                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">í•™ë…„</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.grade || 'í•™ë…„ ì—†ìŒ'}
                    </span>
                  </div>
                </>
              ) : (
                <>
                  {/* ì§ì—… ì •ë³´ (ì§ì¥ì¸ì¸ ê²½ìš°) */}
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">ì§ì—…</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.occupation || 'ì§ì—… ì—†ìŒ'}
                    </span>
                  </div>
            
                  {/* êµ¬ë¶„ì„  */}
                  <div className="border-t border-gray-200"></div>

                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">íšŒì‚¬</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.company || 'íšŒì‚¬ ì—†ìŒ'}
                    </span>
                  </div>

                  {/* êµ¬ë¶„ì„  */}
                  <div className="border-t border-gray-200"></div>

                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 text-sm">ê²½ë ¥</span>
                    <span className="text-gray-800 text-sm font-medium">
                      {profile?.career || 'ê²½ë ¥ ì—†ìŒ'}
                    </span>
                  </div>
                </>
              )}

              {/* êµ¬ë¶„ì„  */}
              <div className="border-t border-gray-200"></div>

              {/* ìê¸°ì†Œê°œ */}
              <div className="flex items-start justify-between">
                <span className="text-gray-600 text-sm">ìê¸°ì†Œê°œ</span>
                <span className="text-gray-800 text-sm font-medium text-right max-w-[60%]">
                  {profile?.introduction || 'ìê¸°ì†Œê°œ ì—†ìŒ'}
                </span>
              </div>
        </div>
      )}
        </div>


            
        {/* ìŠ¤í† ë¦¬ ì„¤ì • ì„¹ì…˜ */}
        <div className="px-4 py-4 bg-white">
          <div className="flex items-center gap-2 mb-3">
            <Settings className="w-4 h-4 text-orange-500" />
            <h2 className="font-semibold text-gray-800">{t('storySettings.globalSettings.title')}</h2>
          </div>
          <StorySettings />
        </div>
            
        {/* ì•Œë¦¼ ì„¤ì • ì„¹ì…˜ */}
        <div className="px-4 py-4 bg-gray-50">
          <div className="flex items-center gap-2 mb-3">
            <Bell className="w-4 h-4 text-blue-500" />
            <h2 className="font-semibold text-gray-800">{t('myTab.notificationSettings')}</h2>
        </div>
        
            <div className="space-y-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Bell className="w-4 h-4 text-purple-600" />
              <div>
                  <div className="font-medium text-gray-800 text-xs">{t('myTab.webPushNotification')}</div>
                  <div className="text-xs text-gray-600">{t('myTab.webPushDescription')}</div>
              </div>
            </div>
            <Switch
              checked={notificationSettings.webPush}
              onCheckedChange={(checked) => handleNotificationChange('webPush', checked)}
            />
          </div>
          
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Mail className="w-4 h-4 text-purple-600" />
              <div>
                  <div className="font-medium text-gray-800 text-xs">{t('myTab.emailNotification')}</div>
                  <div className="text-xs text-gray-600">{t('myTab.emailDescription')}</div>
              </div>
            </div>
            <Switch
              checked={notificationSettings.email}
              onCheckedChange={(checked) => handleNotificationChange('email', checked)}
            />
          </div>
          
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <MessageSquare className="w-4 h-4 text-purple-600" />
              <div>
                  <div className="font-medium text-gray-800 text-xs">{t('myTab.marketingNotification')}</div>
                  <div className="text-xs text-gray-600">{t('myTab.marketingDescription')}</div>
              </div>
            </div>
            <Switch
              checked={notificationSettings.marketing}
              onCheckedChange={(checked) => handleNotificationChange('marketing', checked)}
            />
          </div>
        </div>
      </div>

        {/* í•˜ë‹¨ ì—¬ë°± */}
        <div className="h-20"></div>
        
      </div>
    </div>
  )
}