-- =====================================================
-- 전화번호 중복 방지를 위한 UNIQUE 제약조건 추가
-- Description: 전화번호 중복 계정 생성을 방지
-- Date: 2024-12-19
-- =====================================================

-- 1. 전화번호 UNIQUE 제약조건 추가
ALTER TABLE public.users 
ADD CONSTRAINT unique_phone UNIQUE (phone);

-- 2. 전화번호 인덱스 추가 (성능 최적화)
CREATE INDEX IF NOT EXISTS idx_users_phone ON public.users(phone);

-- 3. 기존 중복 전화번호가 있다면 정리 (필요시)
-- 주의: 실제 운영 환경에서는 신중하게 실행해야 함
-- UPDATE public.users 
-- SET phone = phone || '_duplicate_' || id::text
-- WHERE phone IN (
--     SELECT phone 
--     FROM public.users 
--     GROUP BY phone 
--     HAVING COUNT(*) > 1
-- );

-- =====================================================
-- 추가 설명
-- =====================================================

/*
전화번호 중복 방지 정책:

1. UNIQUE 제약조건:
   - 동일한 전화번호로 여러 계정 생성 불가
   - 데이터베이스 레벨에서 강제

2. 인덱스 추가:
   - 전화번호 검색 성능 향상
   - 중복 체크 쿼리 최적화

3. 기존 중복 데이터 정리:
   - 필요시 주석 해제하여 실행
   - 운영 환경에서는 신중하게 처리

4. API 레벨 검증:
   - 회원가입 시 전화번호 중복 체크
   - 사용자 친화적 오류 메시지 제공

보안 고려사항:
- 전화번호는 개인정보이므로 적절한 암호화 고려
- SMS 인증을 통한 전화번호 검증 권장
- 국가별 전화번호 형식 검증 필요
*/
